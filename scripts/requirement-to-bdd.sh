#!/bin/bash
# scripts/requirement-to-bdd.sh
# éœ€æ±‚åˆ†æžå’Œ BDD å ´æ™¯ç”Ÿæˆå·¥å…·

echo "======================================"
echo "    éœ€æ±‚è®Šæ›´è™•ç†å·¥å…·"
echo "======================================"
echo ""

# è®€å–éœ€æ±‚å…§å®¹
echo "è«‹è¼¸å…¥éœ€æ±‚è®Šæ›´å…§å®¹ï¼ˆæŒ‰ Ctrl+D çµæŸè¼¸å…¥ï¼‰ï¼š"
echo "ç¯„ä¾‹ï¼šç”¨æˆ¶å¸Œæœ›å¯ä»¥ç‚ºæ¯å€‹ä»»å‹™è¨­å®šå„ªå…ˆé †åºï¼ˆé«˜ã€ä¸­ã€ä½Žï¼‰ï¼Œä¸¦ä¸”å¯ä»¥æŒ‰å„ªå…ˆé †åºæŽ’åºä»»å‹™åˆ—è¡¨ã€‚"
echo ""
echo "è«‹è¼¸å…¥ï¼š"

# è®€å–å¤šè¡Œè¼¸å…¥
REQUIREMENT=""
while IFS= read -r line; do
    REQUIREMENT="$REQUIREMENT$line"$'\n'
done

# ç§»é™¤æœ€å¾Œçš„æ›è¡Œç¬¦è™Ÿ
REQUIREMENT=$(echo "$REQUIREMENT" | sed 's/[[:space:]]*$//')

echo ""
echo "æ”¶åˆ°çš„éœ€æ±‚å…§å®¹ï¼š"
echo "----------------------------------------"
echo "$REQUIREMENT"
echo "----------------------------------------"
echo ""

# ç°¡å–®çš„é—œéµå­—åˆ†æž
if echo "$REQUIREMENT" | grep -qi "ç”¨æˆ¶\|åŠŸèƒ½\|æ“ä½œ\|ä»‹é¢\|é¡¯ç¤º\|é»žæ“Š\|è¼¸å…¥\|é¸æ“‡"; then
    echo "âœ… æª¢æ¸¬åˆ°æ¥­å‹™åŠŸèƒ½è®Šæ›´ï¼Œé–‹å§‹ç”Ÿæˆ BDD å ´æ™¯..."
    
    # ç”Ÿæˆæ™‚é–“æˆ³
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    SCENARIO_FILE="temp-scenario-$TIMESTAMP.md"
    
    echo ""
    echo "ðŸ”„ æ­£åœ¨ç”Ÿæˆ BDD å ´æ™¯ç¯„æœ¬..."
    
    # ç”Ÿæˆ BDD å ´æ™¯ç¯„æœ¬
    cat > "$SCENARIO_FILE" << EOF
# æ–°å¢ž BDD å ´æ™¯ - $(date +%Y-%m-%d)

## éœ€æ±‚ä¾†æº
$REQUIREMENT

## ç”Ÿæˆçš„ BDD å ´æ™¯

### Scenario X: [è«‹å¡«å…¥å ´æ™¯åç¨±]

\`\`\`gherkin
Scenario: [è«‹å¡«å…¥å…·é«”å ´æ™¯æè¿°]
  Given [å‰ç½®æ¢ä»¶ - ä¾‹å¦‚ï¼šæˆ‘åœ¨å¾…è¾¦æ¸…å–®ä¸»é é¢]
  When [ç”¨æˆ¶æ“ä½œ - ä¾‹å¦‚ï¼šæˆ‘é»žæ“ŠæŸå€‹æŒ‰éˆ•]
  And [é¡å¤–æ“ä½œ - ä¾‹å¦‚ï¼šæˆ‘è¼¸å…¥æŸäº›è³‡æ–™]
  Then [é æœŸçµæžœ - ä¾‹å¦‚ï¼šæˆ‘æ‡‰è©²çœ‹åˆ°æŸå€‹è®ŠåŒ–]
  And [é¡å¤–é©—è­‰ - ä¾‹å¦‚ï¼šæŸå€‹ç‹€æ…‹æ‡‰è©²æ›´æ–°]
\`\`\`

### Scenario Y: [å¦‚æžœéœ€è¦ç¬¬äºŒå€‹å ´æ™¯]

\`\`\`gherkin
Scenario: [ç¬¬äºŒå€‹å ´æ™¯æè¿°]
  Given [å‰ç½®æ¢ä»¶]
  When [ç”¨æˆ¶æ“ä½œ]
  Then [é æœŸçµæžœ]
\`\`\`

## å»ºè­°çš„ Story

### Story X.X: [Story åç¨±]
- **æè¿°**: ä½œç‚ºç”¨æˆ¶ï¼Œæˆ‘æƒ³è¦ [åŠŸèƒ½æè¿°]ï¼Œä»¥ä¾¿ [åƒ¹å€¼æè¿°]
- **å°æ‡‰ BDD å ´æ™¯**: Scenario X
- **é ä¼°è¤‡é›œåº¦**: [ç°¡å–®/ä¸­ç­‰/è¤‡é›œ]

### Story Y.Y: [å¦‚æžœéœ€è¦ç¬¬äºŒå€‹ Story]
- **æè¿°**: ä½œç‚ºç”¨æˆ¶ï¼Œæˆ‘æƒ³è¦ [åŠŸèƒ½æè¿°]ï¼Œä»¥ä¾¿ [åƒ¹å€¼æè¿°]
- **å°æ‡‰ BDD å ´æ™¯**: Scenario Y
- **é ä¼°è¤‡é›œåº¦**: [ç°¡å–®/ä¸­ç­‰/è¤‡é›œ]

## æŠ€è¡“å½±éŸ¿åˆ†æž

### API å½±éŸ¿
- **æ–°å¢žç«¯é»ž**: [ä¾‹å¦‚ï¼šPOST /api/tasks/priority]
- **ä¿®æ”¹ç«¯é»ž**: [ä¾‹å¦‚ï¼šPUT /api/tasks/{id} - å¢žåŠ  priority æ¬„ä½]

### è³‡æ–™æ¨¡åž‹å½±éŸ¿
- **å½±éŸ¿çš„å¯¦é«”**: [ä¾‹å¦‚ï¼šTask å¯¦é«”éœ€è¦æ–°å¢ž Priority å±¬æ€§]
- **è³‡æ–™åº«è®Šæ›´**: [ä¾‹å¦‚ï¼šéœ€è¦ migration script]

### å‰ç«¯å½±éŸ¿
- **æ–°å¢žå…ƒä»¶**: [ä¾‹å¦‚ï¼šPrioritySelector å…ƒä»¶]
- **ä¿®æ”¹å…ƒä»¶**: [ä¾‹å¦‚ï¼šTaskItem å…ƒä»¶éœ€è¦é¡¯ç¤ºå„ªå…ˆé †åº]
- **ç‹€æ…‹ç®¡ç†**: [ä¾‹å¦‚ï¼šæ–°å¢ž priority ç›¸é—œç‹€æ…‹]

## ä¸‹ä¸€æ­¥è¡Œå‹•
1. [ ] å®Œå–„ä¸Šè¿° BDD å ´æ™¯çš„å…·é«”å…§å®¹
2. [ ] å°‡å®Œæˆçš„å ´æ™¯åŠ å…¥åˆ° docs/bdd-specifications.md
3. [ ] åŸ·è¡Œå½±éŸ¿åˆ†æžï¼š./scripts/analyze-bdd-impact.sh "[é—œéµå­—]"
4. [ ] é–‹å§‹ Story é–‹ç™¼ï¼šåƒè€ƒ story-driven-development-workflow.md
5. [ ] å®Œæˆå¾Œè¨˜éŒ„è®Šæ›´ï¼š./scripts/log-change.sh
EOF

    echo "âœ… BDD å ´æ™¯ç¯„æœ¬å·²ç”Ÿæˆï¼š$SCENARIO_FILE"
    echo ""
    echo "ðŸ“ ä¸‹ä¸€æ­¥è«‹ï¼š"
    echo "   1. ç·¨è¼¯ $SCENARIO_FILE æª”æ¡ˆ"
    echo "   2. å®Œå–„ BDD å ´æ™¯çš„å…·é«”å…§å®¹"
    echo "   3. å°‡å®Œæˆçš„å ´æ™¯è¤‡è£½åˆ° docs/bdd-specifications.md"
    echo "   4. åŸ·è¡Œï¼š./scripts/analyze-bdd-impact.sh \"[é—œéµå­—]\""
    echo ""
    
elif echo "$REQUIREMENT" | grep -qi "æŠ€è¡“\|æž¶æ§‹\|ç’°å¢ƒ\|è³‡æ–™åº«\|éƒ¨ç½²\|é…ç½®\|æ¡†æž¶"; then
    echo "ðŸ”§ æª¢æ¸¬åˆ°åŸºç¤Žè¨­æ–½è®Šæ›´ï¼Œè·³éŽ BDD å ´æ™¯ç”Ÿæˆ"
    echo ""
    echo "å»ºè­°ç›´æŽ¥é€²å…¥æŠ€è¡“å¯¦ä½œéšŽæ®µï¼š"
    echo "   1. æ›´æ–°ç›¸é—œæŠ€è¡“æ–‡ä»¶"
    echo "   2. é–‹å§‹æŠ€è¡“å¯¦ä½œ"
    echo "   3. å®Œæˆå¾ŒåŸ·è¡Œï¼š./scripts/log-change.sh"
    echo ""
    
else
    echo "â“ ç„¡æ³•è‡ªå‹•åˆ†é¡žï¼Œé è¨­ç‚ºæ¥­å‹™åŠŸèƒ½è®Šæ›´"
    echo ""
    echo "å¦‚æžœé€™æ˜¯æ¥­å‹™åŠŸèƒ½è®Šæ›´ï¼Œè«‹é‡æ–°åŸ·è¡Œä¸¦ä½¿ç”¨æ›´æ˜Žç¢ºçš„æè¿°"
    echo "å¦‚æžœé€™æ˜¯æŠ€è¡“è®Šæ›´ï¼Œè«‹ç›´æŽ¥é€²å…¥æŠ€è¡“å¯¦ä½œéšŽæ®µ"
fi

echo ""
echo "======================================"
echo "    éœ€æ±‚è®Šæ›´è™•ç†å®Œæˆ"
echo "======================================"