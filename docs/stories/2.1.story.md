# Story 2.1: 新增待辦任務功能

## Status
Done

## Story
**As a** 生產力使用者，
**I want** 在輸入框中快速新增待辦任務，
**so that** 我可以迅速記錄需要完成的工作項目。

## Acceptance Criteria
1. 用戶可以在任務輸入框中輸入任務描述
2. 用戶按下 Enter 鍵或點擊新增按鈕時，任務立即新增到待辦列表
3. 新增成功後，輸入框自動清空，準備下一次輸入
4. 新增的任務顯示在待辦任務列表的頂部
5. 任務計數器即時更新，顯示正確的待辦任務數量
6. 提供視覺載入指示器，載入時間不超過 0.5 秒
7. 空白或只包含空格的任務描述不能新增
8. 任務描述超過最大長度時顯示驗證錯誤
9. 網路錯誤時顯示適當的錯誤訊息
10. 新增的任務資料持久化到 SQLite 資料庫

## Tasks / Subtasks
- [x] 設計和實作任務資料模型 (AC: 10)
  - [x] 建立 TodoTask 實體類別
  - [x] 配置 Entity Framework DbContext
  - [x] 建立資料庫遷移腳本
  - [x] 建立 Task 資料表結構
- [x] 實作後端 CQRS 命令和處理器 (AC: 2, 10)
  - [x] 建立 CreateTaskCommand 命令
  - [x] 實作 CreateTaskCommandHandler
  - [x] 建立 CreateTaskCommandValidator 驗證器
  - [x] 建立 TaskDto 回應模型
- [x] 實作 REST API 端點 (AC: 2, 7, 8, 9)
  - [x] 建立 TasksController 控制器
  - [x] 實作 POST /api/tasks 端點
  - [x] 新增請求驗證和錯誤處理
  - [x] 配置 API 回應格式
- [x] 建立前端任務管理服務 (AC: 2, 6, 9)
  - [x] 建立 TaskService 服務
  - [x] 實作 createTask API 呼叫方法
  - [x] 新增載入狀態管理
  - [x] 實作錯誤處理和重試機制
- [x] 實作任務輸入元件 (AC: 1, 3, 7, 8)
  - [x] 建立 TaskInputComponent 元件
  - [x] 實作輸入框和新增按鈕
  - [x] 新增客戶端驗證邏輯
  - [x] 實作 Enter 鍵事件處理
- [x] 實作任務列表元件 (AC: 4, 5, 6)
  - [x] 建立 TaskListComponent 元件
  - [x] 實作任務顯示和計數功能
  - [x] 新增載入指示器元件
  - [x] 實作即時列表更新
- [x] 整合前後端功能測試 (AC: 1-10)
  - [x] 測試完整的新增任務流程
  - [x] 驗證所有驗證規則正常運作
  - [x] 測試錯誤處理情境
  - [x] 確認資料持久化功能

## Dev Notes

### BDD 測試場景框架
此故事基於以下 BDD 測試場景實作：

**主要測試場景：**
```gherkin
Feature: 新增待辦任務
  As a 生產力使用者
  I want to 快速新增待辦任務
  So that 我可以記錄需要完成的工作

Scenario: 成功新增待辦任務
  Given 我在待辦清單頁面
  And 任務輸入框是空的
  When 我在輸入框中輸入 "完成專案報告"
  And 我按下 Enter 鍵
  Then 任務應該立即出現在列表中
  And 輸入框應該被清空
  And 應該顯示載入指示器 0.5 秒內消失
  And 任務計數應該更新

Scenario: 驗證空白任務描述
  Given 我在待辦清單頁面
  When 我嘗試新增空白任務
  Then 應該顯示驗證錯誤訊息
  And 任務不應該被新增

Scenario: 網路錯誤處理
  Given 我在待辦清單頁面
  When API 服務無法回應
  And 我嘗試新增任務 "測試錯誤處理"
  Then 應該顯示錯誤訊息 "暫時無法連接到服務器"
  And 任務不應該被新增到列表中
```

### 資料模型設計 [Source: architecture.md#資料層架構]
**TodoTask 實體結構：**
```csharp
public class TodoTask
{
    public int Id { get; set; }
    public string Description { get; set; } = string.Empty;
    public bool IsCompleted { get; set; } = false;
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
}
```

**資料庫資料表：**
- 資料表名稱：Tasks
- 主鍵：Id (int, identity)
- 欄位驗證：Description 最大長度 500 字元，不可為空

### CQRS 實作指導 [Source: architecture.md#CQRS 實作指導原則]
**CreateTaskCommand 結構：**
```csharp
public class CreateTaskCommand : IRequest<TaskDto>
{
    public string Description { get; set; } = string.Empty;
}

public class CreateTaskCommandValidator : AbstractValidator<CreateTaskCommand>
{
    public CreateTaskCommandValidator()
    {
        RuleFor(x => x.Description)
            .NotEmpty().WithMessage("請輸入任務描述")
            .MaximumLength(500).WithMessage("任務描述不能超過 500 字元");
    }
}

public class CreateTaskCommandHandler : IRequestHandler<CreateTaskCommand, TaskDto>
{
    // 實作建立任務邏輯，包含資料驗證和持久化
}
```

### API 端點設計 [Source: architecture.md#API 控制器指導原則]
**REST API 規格：**
- 端點：`POST /api/tasks`
- 請求體：`{ "description": "任務描述" }`
- 成功回應：`201 Created` + TaskDto
- 錯誤回應：`400 Bad Request` (驗證錯誤)、`500 Internal Server Error` (系統錯誤)

### 前端元件架構 [Source: architecture.md#前端架構]
**檔案結構：**
```
src/app/features/todo/
├── components/
│   ├── task-input/
│   │   ├── task-input.component.ts
│   │   ├── task-input.component.html
│   │   └── task-input.component.scss
│   └── task-list/
│       ├── task-list.component.ts
│       ├── task-list.component.html
│       └── task-list.component.scss
├── services/
│   └── task.service.ts
└── models/
    └── task.interface.ts
```

**狀態管理：** [Source: architecture.md#狀態管理策略]
- 使用 Angular Signals 管理任務列表狀態
- RxJS Observable 處理 API 呼叫和錯誤處理
- 載入狀態使用 BehaviorSubject 管理

### 測試要求 [Source: bdd-testing-strategy.md]
**前端 BDD 測試：**
- 測試框架：Cucumber + Angular Testing
- 測試檔案：`tests/frontend-bdd/features/task-creation.feature`
- 步驟定義：`tests/frontend-bdd/step_definitions/task-creation.steps.ts`

**後端 BDD 測試：**
- 測試框架：SpecFlow + xUnit
- 測試檔案：`tests/backend-bdd/Features/TaskCreation.feature`
- 步驟定義：`tests/backend-bdd/StepDefinitions/TaskCreationSteps.cs`

**E2E BDD 測試：**
- 測試框架：SpecFlow + Selenium
- 完整使用者情境驗證
- 瀏覽器自動化測試

### 開發環境配置 [Source: CLAUDE.md#前端開發環境]
- 前端開發服務器：`ng serve --port 4200`
- 後端 API 服務器：PORT 5000
- 資料庫：SQLite 檔案型資料庫

### 技術約束 [Source: prd-final.md#Technical Stack]
- 前端：Angular 19.x + TypeScript 5.x
- 後端：.NET 9.x + MediatR 12.x
- 資料庫：SQLite 3.x + Entity Framework Core 9.x
- API：RESTful API 風格
- 回應時間要求：API 回應 < 100ms，UI 回應 < 200ms

### 驗證和錯誤處理
**客戶端驗證：**
- 空白檢查：任務描述不可為空或只包含空格
- 長度限制：最大 500 字元
- 即時驗證回饋

**伺服器端驗證：**
- FluentValidation 驗證器
- 標準化錯誤回應格式
- 適當的 HTTP 狀態碼

**錯誤處理：**
- 網路錯誤：顯示重試機制
- 驗證錯誤：顯示具體錯誤訊息
- 系統錯誤：顯示友善的錯誤提示

### Testing
**測試標準：**
- 前端測試：Jasmine + Karma (Angular 預設)
- 後端測試：xUnit (.NET 標準測試框架)
- BDD 測試：SpecFlow (後端) + Cucumber (前端)
- E2E 測試：SpecFlow + Selenium WebDriver

**測試覆蓋率要求：**
- 單元測試覆蓋率：最低 80%
- BDD 場景覆蓋率：100% 的功能需求
- 整合測試：所有 API 端點

**測試檔案位置：**
- 前端測試：與元件同目錄 `.spec.ts` 檔案
- 後端測試：獨立測試專案 `ToDoListBDD.Tests`
- BDD 測試：`tests/` 目錄下的對應測試專案

**此故事的特定測試需求：**
- 任務建立功能的單元測試
- CQRS 命令和查詢的整合測試
- 前後端 API 整合測試
- 完整的 BDD 場景驗證
- 錯誤處理情境測試

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-21 | 1.0 | 初始故事建立，包含 BDD 場景框架 | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- BDD 測試檔案：`src/backend/ToDoListBDD.Tests/Features/TaskCreation.feature`
- 步驟定義檔案：`src/backend/ToDoListBDD.Tests/StepDefinitions/TaskCreationSteps.cs`
- 後端測試專案：`src/backend/ToDoListBDD.Tests/ToDoListBDD.Tests.csproj`

### Completion Notes List
- ✅ 成功建立 BDD 測試場景，所有後端 SpecFlow 測試通過 (4/4 scenarios)
- ✅ 實作 TodoTask 實體類別，包含完整的資料驗證和 EF Core 配置
- ✅ 實作完整的 CQRS 架構：CreateTaskCommand, Handler, Validator
- ✅ 實作 REST API 端點，包含完整的錯誤處理和驗證
- ✅ 後端功能完全符合 BDD 測試要求，所有驗證場景通過
- ✅ 實作前端 TaskService 服務，使用 Angular Signals 進行狀態管理
- ✅ 實作 TaskInputComponent 元件，支援輸入驗證和 Enter 鍵事件
- ✅ 實作 TaskListComponent 元件，支援任務顯示、計數和載入指示器
- ✅ 前端 BDD 測試場景建立完成，覆蓋成功建立、驗證錯誤和網路錯誤情境
- ✅ 前端單元測試全部通過 (41/41 tests passed)
- ✅ 修復 TypeScript 匯入錯誤，確保所有元件正確編譯
- ✅ 完整前後端整合，符合所有 10 項驗收標準

### File List
**新建後端檔案：**
- `src/backend/ToDoListBDD.API/DomainEntities/TodoTask.cs` - 任務實體類別
- `src/backend/ToDoListBDD.API/ApplicationCommands/CreateTaskCommand.cs` - CQRS 命令
- `src/backend/ToDoListBDD.API/ApplicationDTOs/TaskDto.cs` - 回應 DTO
- `src/backend/ToDoListBDD.API/Application/Validators/CreateTaskCommandValidator.cs` - 驗證器
- `src/backend/ToDoListBDD.API/Application/Handlers/CreateTaskCommandHandler.cs` - 命令處理器
- `src/backend/ToDoListBDD.API/Controllers/TasksController.cs` - API 控制器
- `src/backend/ToDoListBDD.Tests/Features/TaskCreation.feature` - BDD 測試場景
- `src/backend/ToDoListBDD.Tests/StepDefinitions/TaskCreationSteps.cs` - BDD 步驟定義

**新建前端檔案：**
- `src/frontend/src/app/features/todo/models/task.interface.ts` - 前端任務介面定義
- `src/frontend/src/app/features/todo/services/task.service.ts` - 任務管理服務 (Angular Signals)
- `src/frontend/src/app/features/todo/services/task.service.spec.ts` - 任務服務單元測試
- `src/frontend/src/app/features/todo/components/task-input/task-input.component.ts` - 任務輸入元件
- `src/frontend/src/app/features/todo/components/task-input/task-input.component.html` - 任務輸入模板
- `src/frontend/src/app/features/todo/components/task-input/task-input.component.scss` - 任務輸入樣式
- `src/frontend/src/app/features/todo/components/task-input/task-input.component.spec.ts` - 任務輸入單元測試
- `src/frontend/src/app/features/todo/components/task-list/task-list.component.ts` - 任務列表元件
- `src/frontend/src/app/features/todo/components/task-list/task-list.component.html` - 任務列表模板
- `src/frontend/src/app/features/todo/components/task-list/task-list.component.scss` - 任務列表樣式
- `tests/frontend-bdd/features/task-creation.feature` - 前端 BDD 測試場景
- `tests/frontend-bdd/step_definitions/task-creation.steps.ts` - 前端 BDD 步驟定義

**修改檔案：**
- `src/backend/ToDoListBDD.API/Infrastructure/Data/ApplicationDbContext.cs` - 新增 TodoTask DbSet 和配置
- `src/backend/ToDoListBDD.API/Program.cs` - 新增 FluentValidation 註冊和公開 Program 類別
- `src/backend/ToDoListBDD.Tests/ToDoListBDD.Tests.csproj` - 新增 SpecFlow 相關套件

## QA Results

### Review Date: 2025-08-21

### Reviewed By: Quinn (Test Architect) 

### 程式碼品質評估

**整體評估**: 優秀的實作品質，展現出良好的軟體工程實務

**架構品質**: 
- ✅ 正確實作了 CQRS 模式，清楚分離命令與查詢責任
- ✅ 使用 MediatR 提供優雅的請求處理機制
- ✅ Entity Framework Core 配置正確，具備適當的資料驗證
- ✅ 前端使用 Angular 19 Signals 進行反應式狀態管理，展現現代化技術應用

**程式碼風格與結構**:
- ✅ 檔案組織清楚，遵循特徵分層架構 (feature-based architecture)
- ✅ 命名規範一致，程式碼自說明性良好
- ✅ 適當的關注點分離，每個類別職責明確
- ✅ 錯誤處理完整，涵蓋網路錯誤、驗證錯誤和系統錯誤

### 無需重構

在此次審查中，程式碼品質已達到生產環境標準，無需執行額外重構。開發團隊已展現出高品質的技術實作。

### 合規性檢查

- **編碼標準**: ✅ 遵循 .NET 和 Angular 最佳實務
- **專案結構**: ✅ 符合預期的多層架構設計
- **測試策略**: ✅ 完整的 BDD 測試覆蓋，包含後端 SpecFlow (4/4 scenarios) 和前端 Cucumber 測試
- **所有驗收標準**: ✅ 全部10項驗收標準皆已實作並驗證

### 改進檢查清單

所有重要的程式碼品質改進皆已處理完成：

- [x] 後端驗證：FluentValidation 實作完整
- [x] 前端驗證：客戶端與伺服器端雙重驗證機制
- [x] 錯誤處理：全面的錯誤處理策略，包含重試機制
- [x] 測試覆蓋：41/41 前端測試通過，4/4 後端 BDD 場景通過
- [x] 狀態管理：使用現代化 Angular Signals 模式
- [x] API 設計：RESTful 設計原則，適當的 HTTP 狀態碼
- [x] 資料持久化：正確的 Entity Framework 實作

### 安全性審查

**評估結果**: PASS

- ✅ **輸入驗證**: 客戶端和伺服器端雙重驗證，防範惡意輸入
- ✅ **SQL 注入防護**: 使用 Entity Framework Core 的參數化查詢，無 SQL 注入風險
- ✅ **資料驗證**: FluentValidation 和 DataAnnotations 雙重防護
- ✅ **錯誤資訊洩露**: 錯誤訊息經過適當過濾，不洩露內部實作細節
- ✅ **長度限制**: 任務描述限制在 500 字元，防範 DoS 攻擊

**建議關注項目** (未來版本):
- 考慮加入 API 速率限制 (rate limiting)
- 實作 API 金鑰或身分驗證機制

### 效能考量

**評估結果**: PASS

- ✅ **回應時間**: API 設計簡潔，預期能達到 < 100ms 的回應時間要求
- ✅ **前端效能**: Angular Signals 提供高效的變更偵測機制
- ✅ **資料庫查詢**: 使用 Entity Framework Core 的高效查詢
- ✅ **記憶體管理**: 適當的 Observable 訂閱管理，避免記憶體洩漏

### 在審查期間修改的檔案

無 - 程式碼品質已符合生產環境標準，無需修改

### Gate Status

Gate: PASS → docs/qa/gates/2.1-新增待辦任務功能.yml

### 建議狀態

✅ **Ready for Done** - 所有驗收標準已達成，程式碼品質優良，可進入生產環境