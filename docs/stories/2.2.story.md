# Story 2.2: 標記任務完成/待辦狀態功能

## Status
Draft

## Story
**As a** 生產力使用者，
**I want** 點擊任務勾選框來切換任務的完成/待辦狀態，
**so that** 我可以追蹤工作進度並區分已完成和待辦的任務。

## Acceptance Criteria
1. 每個任務項目都有一個可點擊的勾選框
2. 點擊勾選框時，任務狀態立即在待辦和已完成之間切換
3. 已完成的任務顯示勾選標記，文字有劃線效果
4. 待辦任務顯示空白勾選框，文字正常顯示
5. 狀態切換時提供流暢的視覺動畫效果（0.3秒內完成）
6. 任務計數器即時更新，正確顯示待辦和已完成任務數量
7. 已完成的任務在視覺上與待辦任務有明確區分
8. 狀態變更即時同步到後端 API 和資料庫
9. 網路錯誤時狀態回滾並顯示錯誤訊息
10. 支援鍵盤操作（空白鍵切換選中任務的狀態）
11. 已完成任務可以重新標記為待辦狀態
12. 狀態變更時更新任務的 UpdatedAt 時間戳記

## Tasks / Subtasks
- [ ] 擴展後端 CQRS 命令處理 (AC: 8, 12)
  - [ ] 建立 UpdateTaskStatusCommand 命令
  - [ ] 實作 UpdateTaskStatusCommandHandler
  - [ ] 建立 UpdateTaskStatusCommandValidator 驗證器
  - [ ] 更新 TaskDto 包含狀態資訊
- [ ] 實作 REST API 端點 (AC: 8, 9)
  - [ ] 在 TasksController 新增 PATCH /api/tasks/{id}/status 端點
  - [ ] 實作任務 ID 驗證邏輯
  - [ ] 新增狀態更新錯誤處理
  - [ ] 確保資料庫事務完整性
- [ ] 建立任務狀態查詢功能 (AC: 6)
  - [ ] 建立 GetTasksQuery 查詢（如果尚未存在）
  - [ ] 實作 GetTasksQueryHandler
  - [ ] 新增按狀態篩選的功能
  - [ ] 優化查詢效能
- [ ] 擴展前端任務服務 (AC: 8, 9)
  - [ ] 在 TaskService 新增 updateTaskStatus API 方法
  - [ ] 實作樂觀更新和錯誤回滾機制
  - [ ] 新增載入狀態管理
  - [ ] 實作重試機制
- [ ] 實作任務項目勾選框元件 (AC: 1, 2, 3, 4)
  - [ ] 在 TaskListComponent 新增勾選框 UI
  - [ ] 實作勾選框點擊事件處理
  - [ ] 新增任務狀態變更邏輯
  - [ ] 實作即時視覺狀態更新
- [ ] 實作視覺效果和動畫 (AC: 5, 7)
  - [ ] 建立 CSS 動畫效果（劃線、淡化等）
  - [ ] 實作狀態切換動畫（0.3秒轉場）
  - [ ] 新增任務項目視覺狀態類別
  - [ ] 優化已完成任務的視覺呈現
- [ ] 實作任務計數功能 (AC: 6)
  - [ ] 更新 TaskListComponent 計數邏輯
  - [ ] 實作即時計數更新
  - [ ] 新增待辦/已完成任務分別計數
  - [ ] 確保計數準確性
- [ ] 實作鍵盤操作支援 (AC: 10)
  - [ ] 新增鍵盤事件監聽
  - [ ] 實作空白鍵切換功能
  - [ ] 新增任務項目焦點管理
  - [ ] 確保鍵盤操作無障礙性
- [ ] 整合前後端功能測試 (AC: 1-12)
  - [ ] 測試完整的狀態切換流程
  - [ ] 驗證視覺效果和動畫
  - [ ] 測試錯誤處理和回滾機制
  - [ ] 確認資料持久化和同步

## Dev Notes

### 依賴前一個故事
此故事依賴 **Story 2.1**（新增待辦任務功能）的完成：
- 需要 TodoTask 資料模型和資料庫結構
- 需要基本的 CQRS 架構和 MediatR 配置
- 需要 TasksController 和基本 API 結構
- 需要前端 TaskService 和基本元件結構

### BDD 測試場景框架
此故事基於以下 BDD 測試場景實作：

**主要測試場景：**
```gherkin
Feature: 標記任務完成狀態
  As a 生產力使用者
  I want to 切換任務的完成狀態
  So that 我可以追蹤工作進度

Scenario: 將待辦任務標記為已完成
  Given 我有一個待辦任務 "完成專案報告"
  When 我點擊任務的勾選框
  Then 任務應該顯示勾選標記
  And 任務文字應該顯示劃線效果
  And 應該播放完成動畫
  And 任務計數應該更新為 "0 個待辦任務, 1 個已完成"

Scenario: 將已完成任務重新標記為待辦
  Given 我有一個已完成任務 "完成專案報告"
  When 我點擊任務的勾選框
  Then 任務應該顯示空白勾選框
  And 任務文字劃線效果應該移除
  And 應該播放取消動畫
  And 任務計數應該更新為 "1 個待辦任務, 0 個已完成"

Scenario: 鍵盤操作切換任務狀態
  Given 我有一個待辦任務 "測試任務"
  And 任務項目獲得焦點
  When 我按下空白鍵
  Then 任務狀態應該切換為已完成
  And 應該顯示相應的視覺回饋

Scenario: 網路錯誤時狀態回滾
  Given 我有一個待辦任務 "測試任務"
  When API 服務無法回應
  And 我點擊任務的勾選框
  Then 任務應該暫時顯示為已完成
  And 2 秒後應該回滾到待辦狀態
  And 應該顯示錯誤訊息 "狀態更新失敗，請重試"

Scenario: 任務計數即時更新
  Given 我有 3 個待辦任務和 2 個已完成任務
  When 我將 1 個待辦任務標記為已完成
  Then 計數應該顯示 "2 個待辦任務, 3 個已完成"
  And 計數更新應該立即顯示
```

### 擴展現有資料模型 [Source: Story 2.1 - TodoTask 實體]
**現有的 TodoTask 實體已包含必要欄位：**
```csharp
public class TodoTask
{
    public int Id { get; set; }
    public string Description { get; set; } = string.Empty;
    public bool IsCompleted { get; set; } = false;  // 狀態切換使用此欄位
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;  // 需要在更新時修改
}
```

### CQRS 擴展實作 [Source: architecture.md#CQRS 實作指導原則]
**UpdateTaskStatusCommand 結構：**
```csharp
public class UpdateTaskStatusCommand : IRequest<TaskDto>
{
    public int TaskId { get; set; }
    public bool IsCompleted { get; set; }
}

public class UpdateTaskStatusCommandValidator : AbstractValidator<UpdateTaskStatusCommand>
{
    public UpdateTaskStatusCommandValidator()
    {
        RuleFor(x => x.TaskId)
            .GreaterThan(0).WithMessage("任務 ID 必須大於 0");
    }
}

public class UpdateTaskStatusCommandHandler : IRequestHandler<UpdateTaskStatusCommand, TaskDto>
{
    private readonly ITaskRepository _repository;
    
    public async Task<TaskDto> Handle(UpdateTaskStatusCommand request, CancellationToken cancellationToken)
    {
        var task = await _repository.GetByIdAsync(request.TaskId);
        if (task == null)
            throw new NotFoundException($"找不到 ID 為 {request.TaskId} 的任務");
            
        task.IsCompleted = request.IsCompleted;
        task.UpdatedAt = DateTime.UtcNow;
        
        await _repository.UpdateAsync(task);
        return task.ToDto();
    }
}
```

### API 端點擴展 [Source: architecture.md#API 控制器指導原則]
**新增 API 端點：**
- 端點：`PATCH /api/tasks/{id}/status`
- 請求體：`{ "isCompleted": true/false }`
- 成功回應：`200 OK` + 更新後的 TaskDto
- 錯誤回應：`404 Not Found`（任務不存在）、`400 Bad Request`（驗證錯誤）

```csharp
[HttpPatch("{id}/status")]
public async Task<ActionResult<TaskDto>> UpdateTaskStatus(int id, UpdateTaskStatusRequest request)
{
    var command = new UpdateTaskStatusCommand
    {
        TaskId = id,
        IsCompleted = request.IsCompleted
    };
    
    try
    {
        var result = await _mediator.Send(command);
        return Ok(result);
    }
    catch (NotFoundException)
    {
        return NotFound($"找不到 ID 為 {id} 的任務");
    }
}
```

### 前端服務擴展 [Source: architecture.md#狀態管理策略]
**TaskService 新增方法：**
```typescript
export interface TaskService {
  // 現有方法從 Story 2.1
  createTask(description: string): Observable<Task>;
  
  // 新增方法
  updateTaskStatus(taskId: number, isCompleted: boolean): Observable<Task>;
  toggleTaskStatus(task: Task): Observable<Task>;
}

// 實作樂觀更新和錯誤回滾
updateTaskStatus(taskId: number, isCompleted: boolean): Observable<Task> {
  return this.http.patch<Task>(`/api/tasks/${taskId}/status`, { isCompleted })
    .pipe(
      tap(updatedTask => this.updateTaskInState(updatedTask)),
      catchError(error => {
        this.rollbackTaskStatus(taskId, !isCompleted);
        return throwError(() => error);
      })
    );
}
```

### 前端元件擴展 [Source: architecture.md#前端架構]
**TaskListComponent 新增功能：**
```typescript
// 任務狀態切換方法
onTaskStatusChange(task: Task): void {
  // 樂觀更新
  this.updateTaskLocally(task.id, !task.isCompleted);
  
  this.taskService.updateTaskStatus(task.id, !task.isCompleted)
    .subscribe({
      next: (updatedTask) => {
        this.showSuccessAnimation(updatedTask.id);
      },
      error: (error) => {
        // 回滾變更
        this.updateTaskLocally(task.id, task.isCompleted);
        this.showErrorMessage('狀態更新失敗，請重試');
      }
    });
}

// 鍵盤支援
@HostListener('keydown', ['$event'])
onKeyDown(event: KeyboardEvent): void {
  if (event.code === 'Space' && this.selectedTask) {
    event.preventDefault();
    this.onTaskStatusChange(this.selectedTask);
  }
}
```

### CSS 動畫和視覺效果設計
**任務狀態視覺效果：**
```scss
.task-item {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  
  &.completed {
    .task-text {
      text-decoration: line-through;
      color: #6b7280;
      opacity: 0.7;
    }
    
    .task-checkbox {
      background-color: #10b981;
      color: white;
    }
  }
  
  &.completing {
    animation: taskComplete 0.3s ease-in-out;
  }
  
  &.uncompleting {
    animation: taskUncomplete 0.3s ease-in-out;
  }
}

@keyframes taskComplete {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); background-color: #d1fae5; }
  100% { transform: scale(1); }
}

@keyframes taskUncomplete {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); background-color: #fef3c7; }
  100% { transform: scale(1); }
}

.task-checkbox {
  width: 20px;
  height: 20px;
  border: 2px solid #d1d5db;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  
  &:hover {
    border-color: #10b981;
    background-color: #f0fdf4;
  }
  
  &.checked {
    background-color: #10b981;
    border-color: #10b981;
    
    &::after {
      content: '✓';
      color: white;
      font-size: 14px;
      font-weight: bold;
    }
  }
}
```

### 測試要求 [Source: bdd-testing-strategy.md]
**前端 BDD 測試：**
- 測試檔案：`tests/frontend-bdd/features/task-status-toggle.feature`
- 步驟定義：`tests/frontend-bdd/step_definitions/task-status-toggle.steps.ts`
- 重點測試：勾選框互動、視覺效果、動畫、鍵盤操作

**後端 BDD 測試：**
- 測試檔案：`tests/backend-bdd/Features/TaskStatusUpdate.feature`
- 步驟定義：`tests/backend-bdd/StepDefinitions/TaskStatusUpdateSteps.cs`
- 重點測試：PATCH API、資料驗證、錯誤處理

**E2E BDD 測試：**
- 完整狀態切換流程測試
- 多任務狀態變更場景
- 計數器準確性驗證

### 效能考量
**前端效能：**
- 使用 OnPush 變更檢測策略
- 實作 TrackBy 函數優化 ngFor
- 動畫使用 CSS transforms 避免重排

**後端效能：**
- 使用資料庫索引優化 TaskId 查詢
- 實作適當的快取策略
- 批次狀態更新支援（未來擴展）

### 錯誤處理策略
**網路錯誤：**
- 樂觀更新立即顯示變更
- 錯誤時回滾到原始狀態
- 顯示用戶友善的錯誤訊息
- 提供重試機制

**驗證錯誤：**
- 任務不存在時的處理
- 無效狀態值的處理
- 併發更新衝突處理

### 無障礙性支援
**鍵盤導航：**
- Tab 鍵在任務間導航
- 空白鍵切換選中任務狀態
- Enter 鍵激活選中任務

**螢幕閱讀器：**
- 適當的 ARIA 標籤
- 狀態變更的語音通知
- 語義化的 HTML 結構

### Testing
**測試標準：** [Source: Story 2.1#Testing]
- 前端測試：Jasmine + Karma (Angular 預設)
- 後端測試：xUnit (.NET 標準測試框架)
- BDD 測試：SpecFlow (後端) + Cucumber (前端)
- E2E 測試：SpecFlow + Selenium WebDriver

**此故事的特定測試需求：**
- 任務狀態切換功能的單元測試
- UpdateTaskStatusCommand 的整合測試
- 前端勾選框互動測試
- 視覺效果和動畫測試
- 鍵盤操作的無障礙性測試
- 錯誤處理和回滾機制測試
- 樂觀更新的正確性測試

**測試覆蓋率要求：**
- 單元測試覆蓋率：最低 80%
- BDD 場景覆蓋率：100% 的狀態切換情境
- E2E 測試：完整的使用者互動流程

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-21 | 1.0 | 初始故事建立，包含完整 BDD 場景框架 | Scrum Master |

## Dev Agent Record

### Agent Model Used
_待開發代理填寫_

### Debug Log References
_待開發代理填寫_

### Completion Notes List
_待開發代理填寫_

### File List
_待開發代理填寫_

## QA Results
_待 QA 代理填寫_