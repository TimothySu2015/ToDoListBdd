<div class="task-list-container">
  <!-- ä»»å‹™è¨ˆæ•¸å™¨ -->
  <div class="task-counter" data-testid="task-counter">
    <h2>å¾…è¾¦ä»»å‹™</h2>
    <div class="task-counts">
      <span class="pending-count">
        {{ taskService.pendingTaskCount() }} å€‹å¾…è¾¦ä»»å‹™
      </span>
      <span class="separator">Â·</span>
      <span class="completed-count">
        {{ taskService.completedTaskCount() }} å€‹å·²å®Œæˆ
      </span>
    </div>
  </div>

  <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
  <div 
    *ngIf="taskService.loading()" 
    class="loading-container"
    data-testid="loading-container"
  >
    <div class="loading-spinner-large"></div>
    <p>è¼‰å…¥ä»»å‹™ä¸­...</p>
  </div>

  <!-- éŒ¯èª¤è¨Šæ¯ -->
  <div 
    *ngIf="hasError()" 
    class="error-container"
    data-testid="error-container"
  >
    <div class="error-icon">âš ï¸</div>
    <div class="error-content">
      <h3>è¼‰å…¥å¤±æ•—</h3>
      <p>{{ taskService.error() }}</p>
      <button 
        type="button" 
        class="retry-button"
        (click)="retry()"
        data-testid="retry-button"
      >
        é‡æ–°è¼‰å…¥
      </button>
    </div>
  </div>

  <!-- ç©ºç‹€æ…‹ -->
  <div 
    *ngIf="isEmpty() && !taskService.loading() && !hasError()" 
    class="empty-state"
    data-testid="empty-state"
  >
    <div class="empty-icon">ğŸ“‹</div>
    <h3>ç›®å‰æ²’æœ‰ä»»å‹™</h3>
    <p>å¤ªæ£’äº†ï¼æ‰€æœ‰ä»»å‹™éƒ½å·²å®Œæˆï¼Œæˆ–è€…æ‚¨å¯ä»¥æ–°å¢æ–°çš„ä»»å‹™é–‹å§‹å·¥ä½œã€‚</p>
    <div class="empty-actions">
      <button 
        type="button" 
        class="refresh-button"
        (click)="reloadTasks()"
        [disabled]="taskService.loading()"
        data-testid="empty-refresh-button"
      >
        ğŸ”„ é‡æ–°æ•´ç†
      </button>
    </div>
  </div>

  <!-- ä»»å‹™åˆ—è¡¨ -->
  <div 
    *ngIf="!isEmpty() && !hasError()" 
    class="task-list"
    data-testid="task-list"
  >
    <div 
      *ngFor="let task of taskService.tasks(); trackBy: trackByTaskId; index as i" 
      class="task-item"
      [class.completed]="task.isCompleted"
      [class.completing]="isTaskAnimating(task.id, 'completing')"
      [class.uncompleting]="isTaskAnimating(task.id, 'uncompleting')"
      [class.deleting]="isTaskAnimating(task.id, 'deleting')"
      [class.selected]="selectedTaskId() === task.id"
      [class.editing-mode]="isEditing(task.id)"
      [attr.data-task-id]="task.id"
      [attr.data-testid]="'task-item-' + task.id"
      [attr.data-index]="i"
      tabindex="0"
      (click)="selectTask(task.id)"
      (keydown)="onTaskItemKeydown($event, task)"
    >
      <div class="task-content">
        <div class="task-checkbox"
             [class.checked]="task.isCompleted"
             [class.completing]="isTaskAnimating(task.id, 'completing')"
             [class.uncompleting]="isTaskAnimating(task.id, 'uncompleting')"
             (click)="onTaskStatusToggle(task)"
             data-testid="task-checkbox"
             role="checkbox"
             [attr.aria-checked]="task.isCompleted"
             tabindex="0"
             (keydown)="onCheckboxKeydown($event, task)">
          <div class="checkbox-indicator">
            <span *ngIf="task.isCompleted" class="checkmark">âœ“</span>
          </div>
        </div>
        
        <div class="task-details">
          <!-- æ­£å¸¸é¡¯ç¤ºæ¨¡å¼ -->
          <p *ngIf="!isEditing(task.id)" 
             class="task-description task-text" 
             [class.completed-text]="task.isCompleted"
             [title]="task.description"
             (dblclick)="onTaskTextDoubleClick(task)">
            {{ task.description }}
          </p>
          
          <!-- ç·¨è¼¯æ¨¡å¼ -->
          <input *ngIf="isEditing(task.id)"
                 type="text"
                 class="edit-input editing"
                 [value]="editingText()"
                 (input)="onEditTextChange($event)"
                 (keydown)="onEditKeydown($event)"
                 (blur)="onEditBlur()"
                 [attr.data-testid]="'edit-input-' + task.id"
                 maxlength="500"
                 placeholder="è¼¸å…¥ä»»å‹™æè¿°...">
          
          <div class="task-meta">
            <span class="task-time">{{ formatDate(task.createdAt) }}</span>
            <span class="task-id">ID: {{ task.id }}</span>
          </div>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰éˆ•å€åŸŸ -->
      <div class="task-actions">
        <button 
          class="delete-btn"
          (click)="showDeleteDialog(task); $event.stopPropagation()"
          title="åˆªé™¤ä»»å‹™"
          [attr.data-testid]="'delete-button-' + task.id"
          [attr.aria-label]="'åˆªé™¤ä»»å‹™ï¼š' + task.description"
        >
          <span class="delete-icon">ğŸ—‘ï¸</span>
        </button>
      </div>

      <!-- æ–°ä»»å‹™æ¨™è¨˜ (å‰3å€‹ä»»å‹™é¡¯ç¤º) -->
      <div 
        *ngIf="i < 3" 
        class="new-task-badge"
        data-testid="new-task-badge"
      >
        æ–°å¢
      </div>
    </div>
  </div>

  <!-- åˆ—è¡¨åº•éƒ¨è³‡è¨Š -->
  <div 
    *ngIf="!isEmpty() && !hasError()" 
    class="list-footer"
    data-testid="list-footer"
  >
    <p class="list-info">
      å…± {{ taskService.taskCount() }} é …ä»»å‹™
      <span *ngIf="taskService.incompleteTasks().length > 0">
        Â· {{ taskService.incompleteTasks().length }} é …å¾…å®Œæˆ
      </span>
    </p>
    
    <button 
      type="button" 
      class="refresh-button"
      (click)="reloadTasks()"
      [disabled]="taskService.loading()"
      data-testid="refresh-button"
    >
      ğŸ”„ é‡æ–°æ•´ç†
    </button>
  </div>

  <!-- ç¢ºèªåˆªé™¤å°è©±æ¡† -->
  <app-confirm-dialog
    [isVisible]="showDeleteConfirm()"
    title="ç¢ºèªåˆªé™¤ä»»å‹™"
    [message]="taskToDelete() ? 'ç¢ºå®šè¦åˆªé™¤ä»»å‹™ã€Œ' + taskToDelete()!.description + 'ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚' : ''"
    (confirmed)="confirmDelete()"
    (cancelled)="cancelDelete()"
    data-testid="delete-confirm-dialog">
  </app-confirm-dialog>

  <!-- Toast é€šçŸ¥å…ƒä»¶ -->
  <app-toast-notification></app-toast-notification>
</div>