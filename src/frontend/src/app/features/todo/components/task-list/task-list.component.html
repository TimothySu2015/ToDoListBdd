<div class="task-list-container">
  <!-- 搜尋元件 -->
  <app-task-search></app-task-search>

  <!-- 任務計數器 -->
  <div class="task-counter" data-testid="task-counter">
    <div class="counter-header">
      <h2>待辦任務</h2>
      <!-- 清除已完成任務按鈕 -->
      <app-clear-completed></app-clear-completed>
    </div>
    <div class="task-counts">
      <span class="pending-count">
        {{ taskService.pendingTaskCount() }} 個待辦任務
      </span>
      <span class="separator">·</span>
      <span class="completed-count">
        {{ taskService.completedTaskCount() }} 個已完成
      </span>
    </div>
  </div>

  <!-- 載入指示器 -->
  <div 
    *ngIf="taskService.loading()" 
    class="loading-container"
    data-testid="loading-container"
  >
    <div class="loading-spinner-large"></div>
    <p>載入任務中...</p>
  </div>

  <!-- 錯誤訊息 -->
  <div 
    *ngIf="hasError()" 
    class="error-container"
    data-testid="error-container"
  >
    <div class="error-icon">⚠️</div>
    <div class="error-content">
      <h3>載入失敗</h3>
      <p>{{ taskService.error() }}</p>
      <button 
        type="button" 
        class="retry-button"
        (click)="retry()"
        data-testid="retry-button"
      >
        重新載入
      </button>
    </div>
  </div>

  <!-- 空狀態 -->
  <div 
    *ngIf="isEmpty() && !taskService.loading() && !hasError()" 
    class="empty-state"
    data-testid="empty-state"
  >
    <!-- 搜尋無結果 -->
    <div *ngIf="searchService.isSearching()" class="no-results" data-testid="no-results">
      <div class="no-results-icon">🔍</div>
      <h3 class="no-results-text" data-testid="no-results-message">找不到匹配的任務</h3>
      <p class="no-results-suggestion" data-testid="no-results-suggestion">
        請嘗試使用不同的搜尋關鍵字，或清除搜尋以查看所有任務。
      </p>
    </div>
    
    <!-- 正常空狀態 -->
    <div *ngIf="!searchService.isSearching()">
      <div class="empty-icon">📋</div>
      <h3 data-testid="empty-message">目前沒有任務</h3>
      <p>太棒了！所有任務都已完成，或者您可以新增新的任務開始工作。</p>
      <div class="empty-actions" data-testid="empty-action">
        <button 
          type="button" 
          class="refresh-button"
          (click)="reloadTasks()"
          [disabled]="taskService.loading()"
          data-testid="empty-refresh-button"
        >
          🔄 重新整理
        </button>
      </div>
    </div>
  </div>

  <!-- 任務列表 -->
  <div 
    *ngIf="!isEmpty() && !hasError()" 
    class="task-list"
    data-testid="task-list"
  >
    <div 
      *ngFor="let task of taskService.tasks(); trackBy: trackByTaskId; index as i" 
      class="task-item"
      [class.completed]="task.isCompleted"
      [class.completing]="isTaskAnimating(task.id, 'completing')"
      [class.uncompleting]="isTaskAnimating(task.id, 'uncompleting')"
      [class.deleting]="isTaskAnimating(task.id, 'deleting')"
      [class.selected]="selectedTaskId() === task.id"
      [class.editing-mode]="isEditing(task.id)"
      [attr.data-task-id]="task.id"
      [attr.data-testid]="'task-item-' + task.id"
      [attr.data-index]="i"
      tabindex="0"
      (click)="selectTask(task.id)"
      (keydown)="onTaskItemKeydown($event, task)"
    >
      <div class="task-content">
        <div class="task-checkbox"
             [class.checked]="task.isCompleted"
             [class.completing]="isTaskAnimating(task.id, 'completing')"
             [class.uncompleting]="isTaskAnimating(task.id, 'uncompleting')"
             (click)="onTaskStatusToggle(task)"
             data-testid="task-checkbox"
             role="checkbox"
             [attr.aria-checked]="task.isCompleted"
             tabindex="0"
             (keydown)="onCheckboxKeydown($event, task)">
          <div class="checkbox-indicator">
            <span *ngIf="task.isCompleted" class="checkmark">✓</span>
          </div>
        </div>
        
        <div class="task-details">
          <!-- 正常顯示模式 -->
          <p *ngIf="!isEditing(task.id)" 
             class="task-description task-text" 
             [class.completed-text]="task.isCompleted"
             [title]="task.description"
             (dblclick)="onTaskTextDoubleClick(task)">
            <app-task-highlight 
              [text]="task.description" 
              [searchTerm]="searchService.getCurrentSearchTerm()">
            </app-task-highlight>
          </p>
          
          <!-- 編輯模式 -->
          <input *ngIf="isEditing(task.id)"
                 type="text"
                 class="edit-input editing"
                 [value]="editingText()"
                 (input)="onEditTextChange($event)"
                 (keydown)="onEditKeydown($event)"
                 (blur)="onEditBlur()"
                 [attr.data-testid]="'edit-input-' + task.id"
                 maxlength="500"
                 placeholder="輸入任務描述...">
          
          <div class="task-meta">
            <span class="task-time">{{ formatDate(task.createdAt) }}</span>
            <span class="task-id">ID: {{ task.id }}</span>
          </div>
        </div>
      </div>

      <!-- 操作按鈕區域 -->
      <div class="task-actions">
        <button 
          class="delete-btn"
          (click)="showDeleteDialog(task); $event.stopPropagation()"
          title="刪除任務"
          [attr.data-testid]="'delete-button-' + task.id"
          [attr.aria-label]="'刪除任務：' + task.description"
        >
          <span class="delete-icon">🗑️</span>
        </button>
      </div>

      <!-- 新任務標記 (前3個任務顯示) -->
      <div 
        *ngIf="i < 3" 
        class="new-task-badge"
        data-testid="new-task-badge"
      >
        新增
      </div>
    </div>
  </div>

  <!-- 列表底部資訊 -->
  <div 
    *ngIf="!isEmpty() && !hasError()" 
    class="list-footer"
    data-testid="list-footer"
  >
    <p class="list-info">
      共 {{ taskService.taskCount() }} 項任務
      <span *ngIf="taskService.incompleteTasks().length > 0">
        · {{ taskService.incompleteTasks().length }} 項待完成
      </span>
    </p>
    
    <button 
      type="button" 
      class="refresh-button"
      (click)="reloadTasks()"
      [disabled]="taskService.loading()"
      data-testid="refresh-button"
    >
      🔄 重新整理
    </button>
  </div>

  <!-- 確認刪除對話框 -->
  <app-confirm-dialog
    [isVisible]="showDeleteConfirm()"
    title="確認刪除任務"
    [message]="taskToDelete() ? '確定要刪除任務「' + taskToDelete()!.description + '」嗎？此操作無法撤銷。' : ''"
    (confirmed)="confirmDelete()"
    (cancelled)="cancelDelete()"
    data-testid="delete-confirm-dialog">
  </app-confirm-dialog>

  <!-- Toast 通知元件 -->
  <app-toast-notification></app-toast-notification>

  <!-- 快捷鍵說明對話框 -->
  <app-shortcut-help></app-shortcut-help>
</div>